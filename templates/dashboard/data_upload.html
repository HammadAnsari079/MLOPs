{% extends 'base.html' %}

{% block title %}Data Upload - MLOps Platform{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900">Data Processing Center</h2>
        <p class="text-gray-600">Upload your data for cleaning, analysis, or ML model training</p>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Upload Data File</h3>
        
        <!-- Drag and Drop Area -->
        <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 transition-colors">
            <div class="flex flex-col items-center justify-center">
                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-lg font-medium text-gray-900 mb-2">Drag & Drop your files here</p>
                <p class="text-gray-500 mb-4">or</p>
                <button id="browse-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Browse Files
                </button>
                <p class="text-gray-500 text-sm mt-4">Supported formats: CSV, Excel (.xlsx, .xls), JSON</p>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".csv,.xlsx,.xls,.json">
        </div>

        <!-- File Info -->
        <div id="file-info" class="mt-4 hidden">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <p class="font-medium text-gray-900" id="file-name">filename.csv</p>
                        <p class="text-sm text-gray-500" id="file-size">0 KB</p>
                    </div>
                </div>
                <button id="remove-file" class="text-gray-400 hover:text-gray-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Processing Status -->
        <div id="processing-status" class="mt-4 hidden">
            <div class="flex items-center p-4 bg-blue-50 rounded-lg">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-3"></div>
                <span class="text-blue-700">Processing your file...</span>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="mt-4 hidden">
            <div class="p-4 bg-red-50 rounded-lg">
                <div class="flex">
                    <svg class="w-5 h-5 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-red-700" id="error-text">Error message</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Preview Section -->
    <div id="data-preview" class="bg-white rounded-lg shadow p-6 mb-8 hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Data Preview</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead id="preview-header" class="bg-gray-50">
                    <!-- Header will be populated by JavaScript -->
                </thead>
                <tbody id="preview-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        <div class="mt-4 text-sm text-gray-500">
            Showing first 10 rows of <span id="total-rows">0</span> total rows
        </div>
    </div>

    <!-- Processing Options -->
    <div id="processing-options" class="bg-white rounded-lg shadow p-6 mb-8 hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Processing Options</h3>
        
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-8">
                <button id="clean-tab" class="tab-button border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Data Cleaning
                </button>
                <button id="train-tab" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 font-medium text-sm">
                    Model Training
                </button>
                <button id="monitor-tab" class="tab-button text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 font-medium text-sm">
                    ML Monitoring
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="clean-content" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Missing Value Handling</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input id="handle-missing" name="handle-missing" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                            <label for="handle-missing" class="ml-2 block text-sm text-gray-900">Handle missing values</label>
                        </div>
                        <div class="ml-6">
                            <label for="missing-strategy" class="block text-sm font-medium text-gray-700">Strategy</label>
                            <select id="missing-strategy" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="auto">Automatic (mean/median based on distribution)</option>
                                <option value="mean">Mean</option>
                                <option value="median">Median</option>
                                <option value="mode">Mode</option>
                                <option value="drop">Drop rows</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Outlier Handling</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input id="handle-outliers" name="handle-outliers" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                            <label for="handle-outliers" class="ml-2 block text-sm text-gray-900">Handle outliers</label>
                        </div>
                        <div class="ml-6 grid grid-cols-2 gap-3">
                            <div>
                                <label for="outlier-method" class="block text-sm font-medium text-gray-700">Method</label>
                                <select id="outlier-method" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="iqr">IQR (Interquartile Range)</option>
                                    <option value="zscore">Z-Score</option>
                                    <option value="percentile">Percentile</option>
                                </select>
                            </div>
                            <div>
                                <label for="outlier-action" class="block text-sm font-medium text-gray-700">Action</label>
                                <select id="outlier-action" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="cap">Cap to boundaries</option>
                                    <option value="remove">Remove outliers</option>
                                    <option value="transform">Log transform</option>
                                </select>
                            </div>
                            <div>
                                <label for="outlier-threshold" class="block text-sm font-medium text-gray-700">Threshold</label>
                                <input type="number" id="outlier-threshold" step="0.1" min="0.1" max="10" value="1.5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Data Quality</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input id="remove-duplicates" name="remove-duplicates" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                            <label for="remove-duplicates" class="ml-2 block text-sm text-gray-900">Remove duplicates</label>
                        </div>
                        <div class="flex items-center">
                            <input id="encode-categorical" name="encode-categorical" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="encode-categorical" class="ml-2 block text-sm text-gray-900">Encode categorical variables</label>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Feature Processing</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input id="standardize-features" name="standardize-features" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="standardize-features" class="ml-2 block text-sm text-gray-900">Standardize features</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="process-data-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Clean Data
                </button>
            </div>
        </div>

        <div id="train-content" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Model Configuration</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="target-column" class="block text-sm font-medium text-gray-700">Target Column</label>
                            <select id="target-column" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">Select target column</option>
                            </select>
                        </div>
                        <div>
                            <label for="algorithm" class="block text-sm font-medium text-gray-700">Algorithm</label>
                            <select id="algorithm" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="random_forest">Random Forest</option>
                                <option value="linear_regression">Linear Regression</option>
                                <option value="logistic_regression">Logistic Regression</option>
                                <option value="svm">Support Vector Machine</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Training Options</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="test-size" class="block text-sm font-medium text-gray-700">Test Size (%)</label>
                            <input type="number" id="test-size" min="10" max="50" value="20" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div class="flex items-center">
                            <input id="cross-validation" name="cross-validation" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                            <label for="cross-validation" class="ml-2 block text-sm text-gray-900">Use Cross-Validation</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="train-model-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Train Model
                </button>
            </div>
        </div>

        <div id="monitor-content" class="tab-content hidden">
            <div class="space-y-6">
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Model Registration</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="model-name" class="block text-sm font-medium text-gray-700">Model Name</label>
                            <input type="text" id="model-name" placeholder="e.g., HousePricePredictor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="model-version" class="block text-sm font-medium text-gray-700">Version</label>
                            <input type="text" id="model-version" value="v1.0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="model-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="model-description" rows="2" placeholder="Describe your model..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Monitoring Configuration</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="drift-threshold" class="block text-sm font-medium text-gray-700">Drift Threshold (PSI)</label>
                            <input type="number" id="drift-threshold" step="0.01" min="0" max="1" value="0.2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="performance-threshold" class="block text-sm font-medium text-gray-700">Performance Threshold</label>
                            <input type="number" id="performance-threshold" step="0.01" min="0" max="1" value="0.8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="alert-email" class="block text-sm font-medium text-gray-700">Alert Email</label>
                            <input type="email" id="alert-email" placeholder="you@example.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button id="setup-monitoring-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Setup Monitoring
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="bg-white rounded-lg shadow p-6 hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Results</h3>
        <div id="results-content">
            <!-- Results will be populated by JavaScript -->
        </div>
        <div class="mt-6 flex space-x-3">
            <button id="download-results-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Download Results
            </button>
            <button id="new-upload-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                New Upload
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let uploadedFile = null;
    let fileData = null;
    let cleanedData = null;
    let cleanedDataFormat = 'json';  // Track the format of cleaned data
    let trainedModel = null;
    let modelId = null;

    // DOM Elements
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFile = document.getElementById('remove-file');
    const processingStatus = document.getElementById('processing-status');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const dataPreview = document.getElementById('data-preview');
    const previewHeader = document.getElementById('preview-header');
    const previewBody = document.getElementById('preview-body');
    const totalRows = document.getElementById('total-rows');
    const processingOptions = document.getElementById('processing-options');
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');

    // Tab Elements
    const cleanTab = document.getElementById('clean-tab');
    const trainTab = document.getElementById('train-tab');
    const monitorTab = document.getElementById('monitor-tab');
    const cleanContent = document.getElementById('clean-content');
    const trainContent = document.getElementById('train-content');
    const monitorContent = document.getElementById('monitor-content');

    // Buttons
    const processDataBtn = document.getElementById('process-data-btn');
    const trainModelBtn = document.getElementById('train-model-btn');
    const setupMonitoringBtn = document.getElementById('setup-monitoring-btn');
    const downloadResultsBtn = document.getElementById('download-results-btn');
    const newUploadBtn = document.getElementById('new-upload-btn');

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // File upload events
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('drop', handleDrop);
        removeFile.addEventListener('click', resetUpload);
        
        // Tab events
        cleanTab.addEventListener('click', () => switchTab('clean'));
        trainTab.addEventListener('click', () => switchTab('train'));
        monitorTab.addEventListener('click', () => switchTab('monitor'));
        
        // Process buttons
        processDataBtn.addEventListener('click', processData);
        trainModelBtn.addEventListener('click', trainModel);
        setupMonitoringBtn.addEventListener('click', setupMonitoring);
        downloadResultsBtn.addEventListener('click', downloadResults);
        newUploadBtn.addEventListener('click', resetUpload);
    });

    // File handling functions
    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.add('border-indigo-500', 'bg-indigo-50');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        dropArea.classList.remove('border-indigo-500', 'bg-indigo-50');
        
        const files = e.dataTransfer.files;
        if (files.length) {
            processFile(files[0]);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length) {
            processFile(files[0]);
        }
    }

    function processFile(file) {
        try {
            // Validate file type
            const validTypes = ['text/csv', 'application/vnd.ms-excel', 
                               'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                               'application/json'];
            const validExtensions = ['.csv', '.xlsx', '.xls', '.json'];
            
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExtension)) {
                showError('Unsupported file type. Please upload CSV, Excel, or JSON files.');
                return;
            }
            
            uploadedFile = file;
            showFileInfo();
            readFileContent(file);
        } catch (error) {
            showError('Error processing file: ' + error.message);
        }
    }

    function showFileInfo() {
        try {
            fileName.textContent = uploadedFile.name;
            fileSize.textContent = formatFileSize(uploadedFile.size);
            fileInfo.classList.remove('hidden');
            dropArea.classList.add('hidden');
        } catch (error) {
            showError('Error displaying file info: ' + error.message);
        }
    }

    function formatFileSize(bytes) {
        try {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        } catch (error) {
            return 'Unknown size';
        }
    }

    function readFileContent(file) {
        try {
            showProcessingStatus('Reading file...');
            
            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            reader.onload = function(e) {
                try {
                    if (fileExtension === 'csv') {
                        // Parse CSV
                        fileData = parseCSV(e.target.result);
                    } else if (fileExtension === 'json') {
                        // Parse JSON
                        fileData = JSON.parse(e.target.result);
                    } else {
                        // For Excel files, we need to send to backend
                        sendFileToBackend(file);
                        return;
                    }
                    
                    hideProcessingStatus();
                    showDataPreview();
                    populateTargetColumns();
                } catch (error) {
                    hideProcessingStatus();
                    showError('Error parsing file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                hideProcessingStatus();
                showError('Error reading file');
            };
            
            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else if (fileExtension === 'json') {
                reader.readAsText(file);
            } else {
                // For Excel files, send to backend
                sendFileToBackend(file);
            }
        } catch (error) {
            hideProcessingStatus();
            showError('Error reading file content: ' + error.message);
        }
    }

    function parseCSV(csvText) {
        try {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"(.*)"$/, '$1'));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(v => v.trim().replace(/^"(.*)"$/, '$1'));
                const row = {};
                
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] || null;
                }
                
                data.push(row);
            }
            
            return data;
        } catch (error) {
            throw new Error('Error parsing CSV: ' + error.message);
        }
    }

    function sendFileToBackend(file) {
        try {
            showProcessingStatus('Processing Excel file...');
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/upload-file/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to process file: ' + response.status);
                }
            })
            .then(data => {
                hideProcessingStatus();
                fileData = data.data;
                showDataPreview();
                populateTargetColumns();
            })
            .catch(error => {
                hideProcessingStatus();
                showError('Error processing file: ' + error.message);
            });
        } catch (error) {
            hideProcessingStatus();
            showError('Error sending file to backend: ' + error.message);
        }
    }

    function showDataPreview() {
        try {
            if (!fileData || fileData.length === 0) {
                showError('No data found in file');
                return;
            }
            
            // Clear previous content
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // Create header
            const headerRow = document.createElement('tr');
            const headers = Object.keys(fileData[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewHeader.appendChild(headerRow);
            
            // Create body (first 10 rows)
            const displayRows = Math.min(10, fileData.length);
            for (let i = 0; i < displayRows; i++) {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    td.textContent = fileData[i][header] || '';
                    row.appendChild(td);
                });
                previewBody.appendChild(row);
            }
            
            totalRows.textContent = fileData.length;
            dataPreview.classList.remove('hidden');
            processingOptions.classList.remove('hidden');
        } catch (error) {
            showError('Error showing data preview: ' + error.message);
        }
    }

    function populateTargetColumns() {
        try {
            if (!fileData || fileData.length === 0) return;
            
            const targetColumnSelect = document.getElementById('target-column');
            const headers = Object.keys(fileData[0]);
            
            // Clear existing options
            targetColumnSelect.innerHTML = '<option value="">Select target column</option>';
            
            // Add headers as options
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                targetColumnSelect.appendChild(option);
            });
        } catch (error) {
            showError('Error populating target columns: ' + error.message);
        }
    }

    function switchTab(tabName) {
        try {
            // Reset all tabs
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('border-indigo-500', 'text-indigo-600');
                tab.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Activate selected tab
            if (tabName === 'clean') {
                cleanTab.classList.add('border-indigo-500', 'text-indigo-600');
                cleanTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                cleanContent.classList.remove('hidden');
            } else if (tabName === 'train') {
                trainTab.classList.add('border-indigo-500', 'text-indigo-600');
                trainTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                trainContent.classList.remove('hidden');
            } else if (tabName === 'monitor') {
                monitorTab.classList.add('border-indigo-500', 'text-indigo-600');
                monitorTab.classList.remove('text-gray-500', 'hover:text-gray-700');
                monitorContent.classList.remove('hidden');
            }
        } catch (error) {
            showError('Error switching tabs: ' + error.message);
        }
    }

    function processData() {
        try {
            if (!fileData) {
                showError('No data to process');
                return;
            }
            
            showProcessingStatus('Cleaning data...');
            
            // Get cleaning configuration
            const config = {
                handle_missing: document.getElementById('handle-missing').checked,
                missing_strategy: document.getElementById('missing-strategy').value,
                handle_outliers: document.getElementById('handle-outliers').checked,
                outlier_method: document.getElementById('outlier-method').value,
                outlier_action: document.getElementById('outlier-action').value,
                outlier_threshold: parseFloat(document.getElementById('outlier-threshold').value),
                remove_duplicates: document.getElementById('remove-duplicates').checked,
                encode_categorical: document.getElementById('encode-categorical').checked,
                standardize_features: document.getElementById('standardize-features').checked
            };
            
            // Determine file format
            let fileFormat = 'json';
            if (uploadedFile && uploadedFile.name) {
                const fileExtension = uploadedFile.name.split('.').pop().toLowerCase();
                if (['xlsx', 'xls', 'csv'].includes(fileExtension)) {
                    fileFormat = fileExtension;
                }
            }
            
            // Send to cleaning API
            fetch('/api/clean-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: fileData,
                    config: config,
                    file_format: fileFormat  // Pass file format to API
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to clean data: ' + response.status);
                }
            })
            .then(result => {
                hideProcessingStatus();
                cleanedData = result.cleaned_data;
                // Store original format for download
                if (result.original_format) {
                    cleanedDataFormat = result.original_format;
                } else {
                    cleanedDataFormat = 'json';
                }
                showResults('Data cleaning completed successfully!', result);
            })
            .catch(error => {
                hideProcessingStatus();
                showError('Error cleaning data: ' + error.message);
            });
        } catch (error) {
            hideProcessingStatus();
            showError('Error processing data: ' + error.message);
        }
    }

    function trainModel() {
        try {
            if (!fileData) {
                showError('No data to train on');
                return;
            }
            
            const targetColumn = document.getElementById('target-column').value;
            if (!targetColumn) {
                showError('Please select a target column');
                return;
            }
            
            showProcessingStatus('Training model...');
            
            // Get training configuration
            const config = {
                target_column: targetColumn,
                algorithm: document.getElementById('algorithm').value,
                test_size: parseInt(document.getElementById('test-size').value) / 100,
                cross_validation: document.getElementById('cross-validation').checked
            };
            
            // Send to training API
            fetch('/api/train/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: fileData,
                    config: config
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to train model: ' + response.status);
                }
            })
            .then(result => {
                hideProcessingStatus();
                trainedModel = result;
                showResults('Model training completed successfully!', result);
            })
            .catch(error => {
                hideProcessingStatus();
                showError('Error training model: ' + error.message);
            });
        } catch (error) {
            hideProcessingStatus();
            showError('Error training model: ' + error.message);
        }
    }

    function setupMonitoring() {
        try {
            const modelName = document.getElementById('model-name').value;
            const modelVersion = document.getElementById('model-version').value;
            
            if (!modelName) {
                showError('Please enter a model name');
                return;
            }
            
            if (!trainedModel) {
                showError('Please train a model first');
                return;
            }
            
            showProcessingStatus('Setting up monitoring...');
            
            // Register model
            const modelData = {
                name: modelName,
                version: modelVersion,
                description: document.getElementById('model-description').value
            };
            
            fetch('/api/models/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(modelData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to register model: ' + response.status);
                }
            })
            .then(model => {
                modelId = model.id;
                
                // Setup monitoring configuration
                const monitoringConfig = {
                    model_id: modelId,
                    drift_threshold: parseFloat(document.getElementById('drift-threshold').value),
                    performance_threshold: parseFloat(document.getElementById('performance-threshold').value),
                    alert_email: document.getElementById('alert-email').value
                };
                
                // In a real implementation, you would save this config
                hideProcessingStatus();
                showResults('Monitoring setup completed successfully!', {
                    model: model,
                    monitoring_config: monitoringConfig
                });
            })
            .catch(error => {
                hideProcessingStatus();
                showError('Error setting up monitoring: ' + error.message);
            });
        } catch (error) {
            hideProcessingStatus();
            showError('Error setting up monitoring: ' + error.message);
        }
    }

    function showResults(title, data) {
        try {
            resultsContent.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex">
                        <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-green-800 font-medium">${title}</span>
                    </div>
                </div>
                <div class="mt-4">
                    <pre class="bg-gray-50 p-4 rounded-lg text-sm overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            showError('Error showing results: ' + error.message);
        }
    }

    function downloadResults() {
        try {
            if (!cleanedData && !trainedModel) {
                showError('No results to download');
                return;
            }
            
            if (cleanedData) {
                // Determine the format for download
                let downloadFormat = 'json';
                if (cleanedDataFormat) {
                    downloadFormat = cleanedDataFormat;
                }
                
                // Request file preparation from API
                fetch('/api/download-cleaned-data/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: cleanedData,
                        format: downloadFormat
                    })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to prepare file for download: ' + response.status);
                    }
                })
                .then(result => {
                    try {
                        // Create download link from base64 content
                        const byteCharacters = atob(result.file_content);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], {type: result.content_type});
                        
                        // Create download link
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = result.filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        throw new Error('Error creating download link: ' + error.message);
                    }
                })
                .catch(error => {
                    showError('Error preparing download: ' + error.message);
                });
            } else if (trainedModel) {
                // Download model results as JSON
                const dataToDownload = JSON.stringify(trainedModel, null, 2);
                const blob = new Blob([dataToDownload], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'model_results.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        } catch (error) {
            showError('Error downloading results: ' + error.message);
        }
    }

    function resetUpload() {
        try {
            // Reset all state
            uploadedFile = null;
            fileData = null;
            cleanedData = null;
            cleanedDataFormat = 'json';  // Reset format tracker
            trainedModel = null;
            modelId = null;
            
            // Reset UI
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            dropArea.classList.remove('hidden');
            dataPreview.classList.add('hidden');
            processingOptions.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorMessage.classList.add('hidden');
            hideProcessingStatus();
            
            // Reset form elements
            document.getElementById('handle-missing').checked = true;
            document.getElementById('missing-strategy').value = 'auto';
            document.getElementById('handle-outliers').checked = true;
            document.getElementById('outlier-method').value = 'iqr';
            document.getElementById('outlier-action').value = 'cap';
            document.getElementById('outlier-threshold').value = '1.5';
            document.getElementById('remove-duplicates').checked = true;
            document.getElementById('encode-categorical').checked = false;
            document.getElementById('standardize-features').checked = false;
            document.getElementById('target-column').value = '';
            document.getElementById('algorithm').value = 'random_forest';
            document.getElementById('test-size').value = '20';
            document.getElementById('cross-validation').checked = true;
            document.getElementById('model-name').value = '';
            document.getElementById('model-version').value = 'v1.0';
            document.getElementById('model-description').value = '';
            document.getElementById('drift-threshold').value = '0.2';
            document.getElementById('performance-threshold').value = '0.8';
            document.getElementById('alert-email').value = '';
            
            // Switch to clean tab
            switchTab('clean');
        } catch (error) {
            showError('Error resetting upload: ' + error.message);
        }
    }

    function showProcessingStatus(message) {
        try {
            document.getElementById('processing-status').querySelector('span').textContent = message;
            processingStatus.classList.remove('hidden');
        } catch (error) {
            console.error('Error showing processing status: ' + error.message);
        }
    }

    function hideProcessingStatus() {
        try {
            processingStatus.classList.add('hidden');
        } catch (error) {
            console.error('Error hiding processing status: ' + error.message);
        }
    }

    function showError(message) {
        try {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        } catch (error) {
            console.error('Error showing error message: ' + error.message);
        }
    }
</script>
{% endblock %}