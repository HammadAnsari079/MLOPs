{% extends 'base.html' %}

{% block title %}{{ model.name }} - Model Details{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
    <!-- Model Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">{{ model.name }}</h2>
                <p class="text-gray-600">Version {{ model.version }}</p>
            </div>
            <a href="{% url 'dashboard' %}" class="text-indigo-600 hover:text-indigo-900">
                &larr; Back to Dashboard
            </a>
        </div>

        <!-- Health Status -->
        <div class="mt-4 flex items-center">
            <span id="model-health-status"
                class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                Checking health...
            </span>
            <span id="health-score" class="ml-3 text-sm text-gray-600"></span>
        </div>

        <!-- Monitoring Operations -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <h4 class="text-md font-medium text-gray-900 mb-2">Monitoring Operations</h4>
            <div class="flex flex-wrap gap-2">
                <button onclick="runMetricsTask('{{ model.id }}')"
                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500">
                    Calculate Metrics
                </button>
                <button onclick="runDriftTask('{{ model.id }}')"
                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-purple-500">
                    Detect Drift
                </button>
                <button onclick="runDataQualityTask('{{ model.id }}')"
                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500">
                    Check Data Quality
                </button>
            </div>
            <div id="monitoring-status" class="mt-2 text-xs"></div>
        </div>
    </div>

    <!-- Data Cleaning Tool -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Data Cleaning Tool</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="raw-data" class="block text-sm font-medium text-gray-700">Raw Data (JSON)</label>
                <textarea id="raw-data" rows="8"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    placeholder='[{"feature1": 1.5, "feature2": "A"}, {"feature1": null, "feature2": "B"}]'></textarea>
                <p class="mt-1 text-xs text-gray-500">Enter your raw data as JSON array</p>
            </div>
            <div>
                <label for="cleaned-data" class="block text-sm font-medium text-gray-700">Cleaned Data</label>
                <textarea id="cleaned-data" rows="8"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    placeholder="Cleaned data will appear here" readonly></textarea>
                <p class="mt-1 text-xs text-gray-500">Cleaned data output</p>
            </div>
        </div>
        <div class="mt-4">
            <button onclick="cleanData()"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Clean Data
            </button>
            <button onclick="downloadCleanedData()"
                class="ml-2 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Download Cleaned Data
            </button>
            <div id="cleaning-status" class="mt-2 text-sm"></div>
        </div>
    </div>

    <!-- Prediction Input Form -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Submit New Prediction</h3>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-700">For logistic regression models: Enter your 5 input features as JSON. The
                system will automatically handle the prediction and performance monitoring.</p>
        </div>
        <form id="prediction-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="input-data" class="block text-sm font-medium text-gray-700">Input Data (JSON)</label>
                    <textarea id="input-data" name="input_data" rows="4"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder='{"feature_1": 1.5, "feature_2": 2.0, "feature_3": 3.5, "feature_4": 4.0, "feature_5": 5.0}'></textarea>
                    <p class="mt-1 text-xs text-gray-500">Enter 5 input features as JSON</p>
                </div>
                <div>
                    <label for="prediction-result" class="block text-sm font-medium text-gray-700">Prediction Result
                        (JSON)</label>
                    <textarea id="prediction-result" name="prediction" rows="4"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder='{"predicted_class": 3, "probabilities": [0.1, 0.2, 0.3, 0.25, 0.15]}'></textarea>
                    <p class="mt-1 text-xs text-gray-500">Enter prediction output as JSON</p>
                </div>
            </div>
            <div>
                <label for="latency" class="block text-sm font-medium text-gray-700">Latency (ms) - Optional</label>
                <input type="number" id="latency" name="latency_ms" step="0.01"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    placeholder="45.5">
            </div>
            <div class="flex items-center">
                <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Submit Prediction
                </button>
                <div id="prediction-status" class="ml-4 text-sm"></div>
            </div>
        </form>
    </div>

    <!-- Bulk Prediction Upload -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Bulk Prediction Upload</h3>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-700">Upload a CSV or JSON file containing multiple predictions. The file should
                contain columns for input features, and optionally 'prediction' and 'actual' (ground truth).</p>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-center w-full">
                <label for="bulk-file"
                    class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 20 16">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                        </svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag
                            and drop</p>
                        <p class="text-xs text-gray-500">CSV, Excel, or JSON</p>
                    </div>
                    <input id="bulk-file" type="file" class="hidden" accept=".csv,.xlsx,.xls,.json" />
                </label>
            </div>
            <div id="file-name-display" class="text-sm text-gray-600 hidden"></div>

            <button id="upload-bulk-btn"
                class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                Upload and Process
            </button>
            <div id="bulk-upload-status" class="text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Metrics Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Performance Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Metrics</h3>
            <div id="performance-metrics">
                {% if latest_performance %}
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Accuracy</span>
                            <span class="text-sm font-medium text-gray-700">{{ latest_performance.accuracy|floatformat:2
                                }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full"
                                style="width: {{ latest_performance.accuracy|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Precision</span>
                            <span class="text-sm font-medium text-gray-700">{{
                                latest_performance.precision|floatformat:2 }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full"
                                style="width: {{ latest_performance.precision|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Recall</span>
                            <span class="text-sm font-medium text-gray-700">{{ latest_performance.recall|floatformat:2
                                }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-yellow-600 h-2 rounded-full"
                                style="width: {{ latest_performance.recall|floatformat:0 }}%"></div>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No performance metrics available yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Drift Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Drift Detection</h3>
            <div id="drift-metrics">
                {% if latest_drift %}
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">Overall Drift Status</span>
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if latest_drift.drift_detected %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {% if latest_drift.drift_detected %}Drift Detected{% else %}No Drift{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-700">Drift Score: {{ latest_drift.overall_drift_score
                            }}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Last checked: {{ latest_drift.timestamp|date:"M d, Y H:i"
                            }}</span>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No drift metrics available yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- System Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">System Metrics</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Total Predictions</span>
                        <span class="text-sm font-medium text-gray-700" id="total-predictions">0</span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Avg. Latency</span>
                        <span class="text-sm font-medium text-gray-700">
                            {% if latest_performance.avg_latency_ms %}{{ latest_performance.avg_latency_ms|floatformat:2
                            }}ms{% else %}N/A{% endif %}
                        </span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Error Rate</span>
                        <span class="text-sm font-medium text-gray-700">
                            {% if latest_performance.error_rate %}{{ latest_performance.error_rate|floatformat:2 }}%{%
                            else %}N/A{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Performance Over Time -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-md font-medium text-gray-900 mb-3">Performance Over Time</h3>
            <canvas id="performanceChart" height="200"></canvas>
        </div>

        <!-- Drift Visualization -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-md font-medium text-gray-900 mb-3">Feature Drift Analysis</h3>
            <div id="drift-graph" class="h-48"></div>
        </div>
    </div>

    <!-- Recent Predictions -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Predictions</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            {% if recent_predictions %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Timestamp</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Input</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Prediction</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Latency</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for prediction in recent_predictions %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ prediction.timestamp|date:"M d, Y H:i:s" }}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                <div class="max-w-xs truncate" title="{{ prediction.input_data }}">
                                    {{ prediction.input_data|truncatechars:30 }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div class="max-w-xs truncate" title="{{ prediction.prediction }}">
                                    {{ prediction.prediction|truncatechars:30 }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {% if prediction.latency_ms %}{{ prediction.latency_ms|floatformat:2 }}ms{% else %}N/A{%
                                endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-6">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No predictions yet</h3>
                <p class="mt-1 text-sm text-gray-500">Predictions will appear here once the model starts processing
                    data.</p>
            </div>
            {% endif %}
        </div>
        const formData = new FormData(event.target);
        const inputData = formData.get('input_data');
        const predictionData = formData.get('prediction');
        const latency = formData.get('latency_ms');

        // Validate JSON input
        let inputJson, predictionJson;
        try {
        inputJson = inputData ? JSON.parse(inputData) : {};
        predictionJson = predictionData ? JSON.parse(predictionData) : {};
        } catch (e) {
        showStatus('Invalid JSON format in input or prediction data', 'error');
        return;
        }

        // For logistic regression models, provide helpful defaults if not specified
        if (Object.keys(inputJson).length === 0) {
        showStatus('Please provide input data for prediction', 'error');
        return;
        }

        const predictionPayload = {
        model: '{{ model.id }}',
        input_data: inputJson,
        prediction: predictionJson,
        latency_ms: latency ? parseFloat(latency) : null
        };

        // Submit to API
        fetch('/api/predictions/', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify(predictionPayload)
        })
        .then(response => {
        if (response.ok) {
        return response.json();
        } else {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        })
        .then(data => {
        showStatus('Prediction submitted successfully! Performance metrics will be updated.', 'success');
        // Reset form
        document.getElementById('prediction-form').reset();
        // Refresh recent predictions after a short delay
        setTimeout(() => {
        fetchTotalPredictions();
        // Reload the recent predictions section
        location.reload();
        }, 1500);
        })
        .catch(error => {
        console.error('Error:', error);
        showStatus('Error submitting prediction: ' + error.message, 'error');
        });
        }

        function showStatus(message, type) {
        const statusElement = document.getElementById('prediction-status');
        statusElement.textContent = message;
        statusElement.className = 'ml-4 text-sm ' + (type === 'error' ? 'text-red-600' : 'text-green-600');
        }

        function fetchModelHealth() {
        fetch(`/api/models/{{ model.id }}/health/`)
        .then(response => {
        if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
        })
        .then(data => {
        const statusElement = document.getElementById('model-health-status');
        const scoreElement = document.getElementById('health-score');

        if (statusElement) {
        statusElement.textContent = data.status || 'Unknown';

        // Set color based on status
        statusElement.classList.remove('bg-gray-100', 'text-gray-800', 'bg-green-100', 'text-green-800',
        'bg-yellow-100',
        'text-yellow-800', 'bg-red-100', 'text-red-800');

        if (data.status === 'Healthy') {
        statusElement.classList.add('bg-green-100', 'text-green-800');
        } else if (data.status === 'Degraded') {
        statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
        } else if (data.status === 'Unhealthy') {
        statusElement.classList.add('bg-red-100', 'text-red-800');
        } else {
        statusElement.classList.add('bg-gray-100', 'text-gray-800');
        }
        }

        if (scoreElement) {
        scoreElement.textContent = data.health_score ? `Health Score: ${data.health_score}/100` : '';
        }
        })
        .catch(error => {
        console.error('Error fetching model health:', error);
        const statusElement = document.getElementById('model-health-status');
        if (statusElement) {
        statusElement.textContent = 'Error loading health status';
        statusElement.classList.remove('bg-gray-100', 'text-gray-800', 'bg-green-100', 'text-green-800',
        'bg-yellow-100',
        'text-yellow-800', 'bg-red-100', 'text-red-800');
        statusElement.classList.add('bg-red-100', 'text-red-800');
        }
        });
        }

        function fetchTotalPredictions() {
        fetch(`/api/models/{{ model.id }}/predictions/`)
        .then(response => {
        if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
        })
        .then(data => {
        document.getElementById('total-predictions').textContent = data.length;
        })
        .catch(error => {
        console.error('Error fetching predictions:', error);
        const element = document.getElementById('total-predictions');
        if (element) {
        element.textContent = 'Error';
        }
        });
        }

        function initializeCharts() {
        try {
        // Destroy existing chart instance if it exists
        if (performanceChartInstance) {
        performanceChartInstance.destroy();
        performanceChartInstance = null;
        }

        // Performance Chart - optimized with limited data points
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');

        // Limit data points to prevent performance issues
        const maxDataPoints = 20; // Limit to 20 points instead of loading all

        performanceChartInstance = new Chart(performanceCtx, {
        type: 'line',
        data: {
        // Limit labels to prevent overcrowding
        labels: ['24h ago', '12h ago', '6h ago', 'Now'],
        datasets: [{
        label: 'Accuracy',
        // Limit data points for better performance
        data: [0.92, 0.89, 0.91, 0.93],
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.2,
        pointRadius: 2, // Reduce point size for better performance
        pointHoverRadius: 3
        }, {
        label: 'Precision',
        data: [0.88, 0.85, 0.87, 0.90],
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        tension: 0.2,
        pointRadius: 2,
        pointHoverRadius: 3
        }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
        duration: 300 // Reduce animation duration for better performance
        },
        scales: {
        y: {
        beginAtZero: false,
        min: 0.7,
        max: 1.0
        }
        },
        plugins: {
        legend: {
        labels: {
        font: {
        size: 10 // Reduce font size for better performance
        }
        }
        }
        }
        }
        });
        } catch (error) {
        console.error('Error initializing performance chart:', error);
        // Display error message in chart container
        const chartContainer = document.getElementById('performanceChart');
        if (chartContainer) {
        chartContainer.parentElement.innerHTML = '<p class="text-red-500 text-sm">Error loading performance chart: ' +
            error.message + '</p>';
        }
        }

        try {
        // Destroy existing graph instance if it exists
        if (driftGraphInstance) {
        driftGraphInstance.destroy();
        driftGraphInstance = null;
        }

        // Drift Graph (using Cytoscape.js) - optimized with simpler layout
        driftGraphInstance = cytoscape({
        container: document.getElementById('drift-graph'),
        elements: [
        { data: { id: 'model' } },
        { data: { id: 'feature1', parent: 'model' } },
        { data: { id: 'feature2', parent: 'model' } },
        { data: { id: 'feature3', parent: 'model' } },
        {
        data: {
        id: 'feature1-edge',
        source: 'model',
        target: 'feature1',
        label: 'PSI: 0.15'
        }
        },
        {
        data: {
        id: 'feature2-edge',
        source: 'model',
        target: 'feature2',
        label: 'PSI: 0.28'
        }
        },
        {
        data: {
        id: 'feature3-edge',
        source: 'model',
        target: 'feature3',
        label: 'PSI: 0.05'
        }
        }
        ],
        style: [
        {
        selector: 'node',
        style: {
        'background-color': '#0074D9',
        'label': 'data(id)',
        'color': '#fff',
        'text-valign': 'center',
        'text-halign': 'center',
        'font-size': '8px' // Reduce font size for better performance
        }
        },
        {
        selector: 'edge',
        style: {
        'width': 1, // Reduce line width for better performance
        'line-color': '#888',
        'target-arrow-color': '#888',
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier',
        'label': 'data(label)',
        'text-background-color': '#fff',
        'text-background-opacity': 1,
        'font-size': '7px' // Reduce font size for better performance
        }
        }
        ],
        layout: {
        name: 'grid', // Use simpler grid layout instead of breadthfirst for better performance
        padding: 3
        }
        });
        } catch (error) {
        console.error('Error initializing drift graph:', error);
        // Display error message in graph container
        const graphContainer = document.getElementById('drift-graph');
        if (graphContainer) {
        graphContainer.innerHTML = '<p class="text-red-500 text-sm">Error loading drift graph: ' + error.message + '</p>
        ';
        }
        }
        }

        // Monitoring task functions
        function showMonitoringStatus(message, type) {
        const statusElement = document.getElementById('monitoring-status');
        if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = 'mt-2 text-xs ' + (type === 'error' ? 'text-red-600' : type === 'success' ?
        'text-green-600' :
        'text-blue-600');
        }
        }

        function runMetricsTask(modelId) {
        showMonitoringStatus('Calculating performance metrics...', 'info');
        fetch('/api/run-metrics/', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({ model_id: modelId })
        })
        .then(response => {
        if (response.ok) {
        return response.json();
        } else {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        })
        .then(data => {
        showMonitoringStatus('Performance metrics calculated successfully!', 'success');
        // Refresh the metrics display after a short delay
        setTimeout(() => {
        location.reload();
        }, 1500);
        })
        .catch(error => {
        showMonitoringStatus('Error calculating metrics: ' + error.message, 'error');
        });
        }

        function runDriftTask(modelId) {
        showMonitoringStatus('Detecting data drift...', 'info');
        fetch('/api/run-drift/', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({ model_id: modelId })
        })
        .then(response => {
        if (response.ok) {
        return response.json();
        } else {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        })
        .then(data => {
        showMonitoringStatus('Drift detection completed successfully!', 'success');
        // Refresh the metrics display after a short delay
        setTimeout(() => {
        location.reload();
        }, 1500);
        })
        .catch(error => {
        showMonitoringStatus('Error detecting drift: ' + error.message, 'error');
        });
        }

        function runDataQualityTask(modelId) {
        showMonitoringStatus('Checking data quality...', 'info');
        fetch('/api/run-data-quality/', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({ model_id: modelId })
        })
        .then(response => {
        if (response.ok) {
        return response.json();
        } else {
        throw new Error(`HTTP error! status: ${response.status}`);
        }
        })
        .then(data => {
        showMonitoringStatus('Data quality check completed successfully!', 'success');
        // Refresh the metrics display after a short delay
        setTimeout(() => {
        location.reload();
        }, 1500);
        })
        .catch(error => {
        showMonitoringStatus('Error checking data quality: ' + error.message, 'error');
        });
        }
        </script>
        {% endblock %}